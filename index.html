<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geoportal TFM</title>

  <!-- Leaflet Core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <!-- Leaflet Fullscreen -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.css" />

  <style>
    :root{
      --bg:#1f2937;         /* slate-800 */
      --panel:#111827;      /* gray-900 */
      --card:#0b1220;       /* deep */
      --card2:#0f172a;      /* slate-900 */
      --border:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --brand:#38B2AC;
      --brand2:#319795;
      --danger:#ff4d4d;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 26px rgba(0,0,0,.35);
      --r:16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:white;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(56,178,172,.18), transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, rgba(59,130,246,.18), transparent 55%),
                  var(--bg);
    }

    /* HEADER */
    #header{
      background: linear-gradient(180deg, rgba(30,58,138,1), rgba(30,58,138,.92));
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 12px 14px;
      text-align:center;
    }
    #header h1{
      margin:0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    #header h2{
      margin:6px 0 0 0;
      font-size: 13px;
      font-weight: 700;
      opacity:.95;
    }
    #header p{
      margin:6px 0 0 0;
      font-size: 12px;
      opacity:.9;
    }
    #header a{ color:white; text-decoration:underline; }

    /* LAYOUT */
    #map-container{
      display:flex;
      gap:14px;
      padding:14px;
      align-items:stretch;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* LEFT COLUMN */
    #left-col{
      width:90%;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width: 520px;
    }

    /* MAP WRAP */
    #map-wrap{
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.15);
    }
    #map{ width:100%; height: 800px; }

    /* LOADING OVERLAY */
    #loadingOverlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.38);
      z-index:9999;
      backdrop-filter: blur(3px);
    }
    #loadingOverlay .box{
      background: rgba(17,24,39,.95);
      border:1px solid rgba(255,255,255,.12);
      padding:14px 16px;
      border-radius:14px;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      min-width: 320px;
      text-align:center;
    }
    #loadingOverlay .bar{
      width:100%;
      height:10px;
      background:rgba(255,255,255,.12);
      border-radius:99px;
      overflow:hidden;
      margin-top:10px;
    }
    #loadingOverlay .bar > div{
      height:100%;
      width:0%;
      background:rgba(56,178,172,.92);
      transition: width .15s ease;
    }
    #loadingOverlay .small{
      margin-top:8px;
      font-size:12px;
      color:rgba(255,255,255,.84);
    }

    /* BELOW MAP SECTION (as your screenshot) */
    #below-map{
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow: var(--shadow2);
      background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.88));
    }

    .below-hero{
      padding:16px 16px 14px 16px;
      background: linear-gradient(180deg, rgba(134, 160, 90, .80), rgba(134,160,90,.70));
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .below-title{
      font-weight:900;
      font-size:16px;
      margin:0;
    }
    .below-sub{
      margin-top:8px;
      font-size:12px;
      line-height:1.45;
      color: rgba(255,255,255,.92);
      max-width: 900px;
    }

    .below-3cards{
      padding: 14px 14px 0 14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    .bcard{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 12px 28px rgba(0,0,0,.28);
      display:flex;
      flex-direction:column;
      min-height: 230px;
    }
    .bcard-media{
      height: 110px;
      overflow:hidden;
      background: rgba(0,0,0,.20);
    }
    .bcard-media img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.05) contrast(1.05);
    }
    .bcard-body{
      padding: 12px 12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
    }
    .bcard h4{
      margin:0;
      font-size:13px;
      font-weight:900;
    }
    .bcard p{
      margin:0;
      color: rgba(255,255,255,.75);
      font-size:12px;
      line-height:1.45;
      flex:1;
    }
    .bcard-btn{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:900;
    }
    .bcard-btn:hover{ background: rgba(255,255,255,.16); }

    /* Slider Opinion */
    .below-opinion{
      margin: 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .below-opinion-head{
      padding:12px 14px;
      background: rgba(0,0,0,.22);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .below-opinion-head .t{
      font-weight:900;
      font-size:13px;
      margin:0;
    }
    .below-opinion-head .s{
      margin-top:4px;
      font-size:12px;
      color: rgba(255,255,255,.74);
    }

    .bslider{
      position:relative;
      overflow:hidden;
    }
    .bslides{
      display:flex;
      width:200%;
      transform: translateX(0%);
      transition: transform .35s ease;
    }
    .bslide{
      width:50%;
      padding:14px;
    }
    .bgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .bquote{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
      font-size:12px;
      line-height:1.5;
      color: rgba(255,255,255,.88);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      min-height: 120px;
    }
    .bmeta{
      margin-top:10px;
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,.92);
    }

    .bdots{
      display:flex;
      gap:8px;
      justify-content:center;
      padding: 0 0 14px 0;
    }
    .bdot{
      width:8px;
      height:8px;
      border-radius:99px;
      background: rgba(255,255,255,.35);
      cursor:pointer;
      border:1px solid rgba(255,255,255,.22);
    }
    .bdot.active{
      background: rgba(56,178,172,.95);
      border-color: rgba(56,178,172,.95);
      box-shadow: 0 0 0 4px rgba(56,178,172,.18);
    }

    .below-foot{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px 14px 14px 14px;
      color: rgba(255,255,255,.65);
      font-size:12px;
      border-top:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .below-links{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .below-links a{
      color: rgba(255,255,255,.80);
      text-decoration:none;
      border-bottom:1px dashed rgba(255,255,255,.35);
    }
    .below-links a:hover{ color:white; border-bottom-color:white; }

    /* RIGHT COLUMN */
    #controls{
      width:40%;
      border-radius: 18px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(17,24,39,.86));
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width: 50px;
      max-height: calc(1285px + 12px + 470px);
    }

    #controls-scroll{
      padding:14px;
      overflow:auto;
    }

    /* Panels */
    .panel{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .panel h3{
      margin:0 0 10px 0;
      font-size:13px;
      font-weight:900;
    }

    /* SUMMARY */
    #summary{
      text-align:left;
    }
    #summary .big{
      font-size: 34px;
      font-weight: 900;
      margin-top: 6px;
      letter-spacing: .5px;
    }
    .kpi{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .kpi .row{
      padding:10px;
      border-radius:14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .kpi .row b{ font-size:12px; }
    .note{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.72);
    }
    .note b{ color: var(--danger); }

    /* Last10 */
    #last10-panel .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .btnRefresh{
      padding:6px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(56,178,172,.20);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .btnRefresh:hover{ background: rgba(56,178,172,.28); }

    .muted{ color: var(--muted); font-size:12px; }
    .muted2{ color: var(--muted2); font-size:12px; }

    #listaLast10{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .last10Card{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
      font-size:12px;
      line-height:1.35;
    }
    .last10Card:hover{ background: rgba(255,255,255,.07); transform: translateY(-1px); }

    .blink-red{
      border:1px solid rgba(255,60,60,.65) !important;
      box-shadow: 0 0 0 2px rgba(255,60,60,.25), 0 0 18px rgba(255,60,60,.30);
      animation: blinkBorder 1s infinite;
    }
    @keyframes blinkBorder{
      0%   { background:rgba(255,60,60,.08); }
      50%  { background:rgba(255,60,60,.20); }
      100% { background:rgba(255,60,60,.08); }
    }

    /* Chart box */
    #chart-container{ height: 260px; }
    #chart{ width:100% !important; height:100% !important; }

    /* Filters */
    #filters .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    #filters label{
      font-size:12px;
      color: rgba(255,255,255,.88);
      font-weight:700;
    }
    #filters input[type="checkbox"]{
      transform: scale(1.05);
      accent-color: var(--brand);
      cursor:pointer;
    }
    .btn{
      width:100%;
      margin:6px 0;
      padding:10px 12px;
      background-color: rgba(56,178,172,.18);
      color:white;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .btn:hover{ background-color: rgba(56,178,172,.26); }

    #resetRangeButton{
      background: rgba(255,255,255,.14);
    }
    #resetRangeButton:hover{ background: rgba(255,255,255,.18); }

    /* Concesion panel */
    #concesion-panel .chartbox{
      height: 260px;
      position: relative;
      margin-bottom: 10px;
    }

    .btnXLS{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(56,178,172,.18);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      margin-top:8px;
    }
    .btnXLS:hover{ background: rgba(56,178,172,.26); }

    #totalVisibleBox{
      margin-top:10px;
      text-align:center;
      font-size:12px;
      font-weight:900;
      color: rgba(255,255,255,.90);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:10px;
    }
    #totalVisibleBox span{ color: var(--danger); }

    #listaConcesiones{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .cardPoint{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
      font-size:12px;
      line-height:1.35;
    }
    .cardPoint:hover{ background: rgba(255,255,255,.07); transform: translateY(-1px); }

    /* Draw tooltip */
    .area-tooltip{ background:rgba(0,0,0,0.55); border:none; color:#f8d5e4; }

    /* Layers control headings (kept) */
    .leaflet-control-layers-expanded{
      border-radius:16px;
      overflow:hidden;
      background: rgba(17,24,39,.96);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 16px 40px rgba(0,0,0,0.45);
      padding:10px;
    }
    .lc-heading{
      display:block;
      font-weight:900;
      padding:8px 10px;
      margin:10px 0 6px 0;
      border-radius:12px;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.10);
      color:#ffffff;
      letter-spacing:0.4px;
    }
    .leaflet-control-layers-overlays label.is-heading{
      pointer-events:none;
      cursor:default;
    }
    .leaflet-control-layers-overlays label.is-heading input{
      display:none !important;
    }
    .leaflet-control-layers-overlays label,
    .leaflet-control-layers-base label{
      padding:6px 4px;
      font-size:13px;
      color:white;
    }

    /* Responsive */
    @media (max-width: 1200px){
      #map-container{ flex-direction:column; }
      #left-col, #controls{ width:100%; min-width: unset; }
      #map{ height: 520px; }
      #controls{ max-height: none; }
    }
    @media (max-width: 900px){
      .below-3cards{ grid-template-columns:1fr; }
      .bgrid{ grid-template-columns:1fr; }
      #map{ height: 520px; }
    }
  </style>
</head>

<body>
  <div id="header">
    <h1>"Geoportal para el monitoreo de puntos de calor en la Reserva de la Bi√≥sfera Maya"</h1>
    <h2>Proyecto desarrollado por: PACUNAM</h2>
    <p>Fuente:
      <a href="https://www.earthdata.nasa.gov/learn/find-data/near-real-time/firms" target="_blank">FIRMS</a>
    </p>
  </div>

  <div id="map-container">
    <!-- LEFT -->
    <div id="left-col">
      <div id="map-wrap">
        <div id="map"></div>

        <!-- ‚úÖ Overlay de carga -->
        <div id="loadingOverlay">
          <div class="box">
            <div style="font-weight:900;">Cargando datos‚Ä¶</div>
            <div class="bar"><div id="loadingBar"></div></div>
            <div class="small" id="loadingText">Iniciando‚Ä¶</div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ CONTENIDO SOLO DEBAJO DEL MAPA -->
      <section id="below-map">
        <div class="below-hero">
          <div class="below-title">Sobre el Geoportal</div>
          <div class="below-sub">
            Esta iniciativa de tecnol√≥gica es impulsada por Fundaci√≥n PACUNAM como apoyo a la gesti√≥n y protecci√≥n 
		   del patrimonio natural de Pet√©n, orientada a la detecci√≥n y visualizaci√≥n en l√≠nea de anomal√≠as 
		   t√©rmicas (puntos de calor) para fortalecer la alerta temprana y la toma de decisiones frente a 
		   incendios forestales. El geoportal integra como fuente principal los datos de NASA LANCE ‚Äì FIRMS 
		   (Fire Information for Resource Management System), que provee informaci√≥n casi en tiempo real de 
		   incendios activos a partir de sensores satelitales como MODIS y VIIRS, permitiendo ubicar, filtrar 
		   y dar seguimiento a eventos dentro de la RBM para coordinaci√≥n operativa e intervenciones oportunas.
          </div>
        </div>

        <!-- 3 tarjetas con im√°genes -->
        <div class="below-3cards">
          <article class="bcard">
            <div class="bcard-media">
              <img loading="lazy" src="https://upload.wikimedia.org/wikipedia/commons/6/6c/Uaxactun1.jpg" alt="Pr√°cticas de laboratorio">
            </div>
            <div class="bcard-body">
              <h4>Uaxact√∫n</h4>
<p style="text-align: justify;">
La comunidad de Uaxact√∫n administra una de las concesiones forestales 
comunitarias m√°s grandes dentro de la Zona de Uso M√∫ltiple de la RBM, 
con derecho legal para el uso y manejo sostenible de recursos forestales 
bajo contrato con el Estado guatemalteco. Este modelo comunitario contribuye 
directamente a la conservaci√≥n del bosque y a la seguridad econ√≥mica de sus habitantes, 
quienes integran actividades de aprovechamiento sostenible de madera y 
productos no maderables, implementan planes de manejo forestal y operaciones de 
control y protecci√≥n del territorio, con impactos positivos tanto en la protecci√≥n 
de la biodiversidad como en el desarrollo local.
</p>
              <button class="bcard-btn" type="button" onclick="window.open('https://visituaxactun.com/omyc', '_blank');">Ver m√°s</button>
            </div>
          </article>

          <article class="bcard">
            <div class="bcard-media">
              <img loading="lazy" src="https://scontent.fgua13-1.fna.fbcdn.net/v/t39.30808-6/487297700_1202989548497568_1078029582785962156_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=7b2446&_nc_ohc=BaMx0SkcrYUQ7kNvwH7J0UN&_nc_oc=AdnHuHK1zqf6VNte83fbzaKxci7HCFH25ksbvCf_DAu812oELlPxAaLwX2onQK0l9XJkyivwYsSoXTMtIviaErXY&_nc_zt=23&_nc_ht=scontent.fgua13-1.fna&_nc_gid=mOas7bLIUvnjJstvKDGJNA&oh=00_AfuB1scQCc5LO8wnO5prMxg4uW-KDDDCHaqPYSKWOm8B0Q&oe=69A06BBF" alt="Tecnolog√≠as geoespaciales">
            </div>
            <div class="bcard-body">
              <h4>Afisap - San Andres</h4>
              <p style="text-align: justify;">
La Asociaci√≥n Forestal Integral de San Andr√©s (AFISAP) representa a la comunidad
 concessionaria que gestiona su territorio forestal bajo esquemas de manejo sostenible. 
 Reconocida como una de las organizaciones pioneras en concesiones comunitarias en Pet√©n, 
 su experiencia combina el uso legal de recursos forestales con medidas de conservaci√≥n
 y monitoreo a largo plazo, alineadas con las normas t√©cnicas del Consejo Nacional de 
 √Åreas Protegidas (CONAP). Las actividades incluyen aprovechamiento de madera, control de 
 fuego y lucha contra la tala ilegal en su territorio.
</p>
                <button class="bcard-btn" type="button" onclick="window.open('https://www.escuelamesoamericana.org/nuestro-trabajo/nucleos/asociacion-forestal-integral-san-andres-de-peten/', '_blank');">Ver m√°s</button>
            </div>
          </article>

          <article class="bcard">
            <div class="bcard-media">
              <img loading="lazy" src="https://scontent.fgua13-1.fna.fbcdn.net/v/t1.6435-9/131268737_2854303401510839_4891556671854688189_n.jpg?_nc_cat=104&ccb=1-7&_nc_sid=7b2446&_nc_ohc=A26Gm0BVdWwQ7kNvwF9j2Nr&_nc_oc=Adk93dKL0T9I3PfzGSUzKeo5xMHrDBFbz85i5B_1XcA1452maLKPWGoh1kJtGwCVCJswKrG__N54nL1YZ_yRFltU&_nc_zt=23&_nc_ht=scontent.fgua13-1.fna&_nc_gid=Ei1Fe-rYlE0YmnGNrMi9vQ&oh=00_Afs1hwa8rPRQQNHCTqtMFE5QDY-lc3hoEfoe-evkjHe4wQ&oe=69C1F991" alt="Pr√°cticas de campo">
            </div>
            <div class="bcard-body">
              <h4>Impulsores Suchitecos</h4>
                   <p style="text-align: justify;">
La comunidad de R√≠o Chanchich, bajo la figura de la asociaci√≥n Impulsores Suchitecos, 
gestiona su concesi√≥n forestal con enfoque en el manejo sostenible de recursos naturales. 
Esta concesi√≥n se caracteriza por integrar actividades de vigilancia y protecci√≥n del bosque 
con acciones productivas que apuntan a mejorar las condiciones de vida de sus miembros, reflejando 
el papel clave de las comunidades locales en la conservaci√≥n de grandes extensiones de bosque tropical.
</p>
              <button class="bcard-btn" type="button" onclick="window.open('https://impulsoressuchitecos.blogspot.com/', '_blank');">Ver m√°s</button>
            </div>
          </article>
        </div>



 <!-- 3 tarjetas con im√°genes -->
        <div class="below-3cards">
          <article class="bcard">
            <div class="bcard-media">
              <img loading="lazy" src="https://scontent.fgua13-1.fna.fbcdn.net/v/t39.30808-6/486611955_1088032963367089_5983874901131101633_n.jpg?_nc_cat=100&ccb=1-7&_nc_sid=7b2446&_nc_ohc=vA9Pxonz8ccQ7kNvwHwpuTt&_nc_oc=Adnw-vlX80s3lsdmVTtLdj6ZREmF5C_bFXJC3gQQ1N3Xx2db9koZnbn9JxA0WZPieqr6J4B1n34vHBuW3gglWmbt&_nc_zt=23&_nc_ht=scontent.fgua13-1.fna&_nc_gid=Gb4mUWl9s-mfadE737wHMQ&oh=00_AfvqKvPI-V-eKjHNt_3CxWzDP6UPaL8H3e1y0WytlLSZ8Q&oe=69A04A7F" alt="Pr√°cticas de laboratorio">
            </div>
            <div class="bcard-body">
              <h4>El Esfuerzo</h4>
                   <p style="text-align: justify;">
La concesi√≥n forestal comunitaria de El Esfuerzo representa un ejemplo de 
c√≥mo las comunidades locales gestionan de forma sostenible su territorio forestal 
con respaldo t√©cnico y legal. A trav√©s de planes de manejo forestal, esta 
comunidad combina la conservaci√≥n del bosque con actividades productivas 
que generan beneficios econ√≥micos para sus familias, contribuyendo adem√°s a 
la protecci√≥n de la biodiversidad y al equilibrio ecol√≥gico en la RBM.
</p>
              <button class="bcard-btn" type="button" onclick="window.open('https://www.facebook.com/sociedadcivilelesfuerzo/', '_blank');">Ver m√°s</button>
            </div>
          </article>

          <article class="bcard">
            <div class="bcard-media">
              <img loading="lazy" src="https://turismocooperativacarmelita.com/wp-content/gallery/aldea-carmelita/DSC_0719.JPG" alt="Tecnolog√≠as geoespaciales">
            </div>
            <div class="bcard-body">
              <h4>Carmelita</h4>
                  <p style="text-align: justify;">
La comunidad de Carmelita opera su concesi√≥n forestal comunitaria mediante una 
cooperativa local legalmente constituida, la cual se encarga del uso y manejo sostenible 
del bosque dentro de su √°rea concedida. Su gesti√≥n se enfoca en la producci√≥n de madera y 
productos forestales no maderables, as√≠ como en la protecci√≥n y restauraci√≥n de los 
ecosistemas boscosos, todo bajo los lineamientos de manejo forestal sostenible establecidos 
por la normativa de concesiones comunitarias de la RBM.
</p>
              <button class="bcard-btn" type="button" onclick="window.open('https://turismocooperativacarmelita.com/', '_blank');">Ver m√°s</button>
            </div>
          </article>

          <article class="bcard">
            <div class="bcard-media">
              <img loading="lazy" src="https://scontent.fgua13-1.fna.fbcdn.net/v/t39.30808-6/484085269_3472461686219939_8563485374434542402_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=13d280&_nc_ohc=4k7BdY2JHhYQ7kNvwHjB2gi&_nc_oc=Adk6GrmewAHIDd-8OjZOxuGDj7OdhcAsbD0_-iKpxvXEAh_SNFS1A_TWMWtaQgv5NSyDZFa2APCRx0Q4YkN48gM6&_nc_zt=23&_nc_ht=scontent.fgua13-1.fna&_nc_gid=Krz0kw2UV5dJUdeULzAdBA&oh=00_AfuDOoD7smvJsDAelAzxx7M4Q2Ig8HW_6KgG07xolWoDRA&oe=69A05C4F" alt="Pr√°cticas de campo">
            </div>
            <div class="bcard-body">
              <h4>GIBOR & BAREN</h4>
                   <p style="text-align: justify;">
GIBOR es una organizaci√≥n vinculada a la gesti√≥n forestal y ambiental 
en la regi√≥n norte de Guatemala, que desarrolla actividades relacionadas 
con monitoreo territorial, supervisi√≥n t√©cnica y cumplimiento ambiental en 
√°reas bajo manejo sostenible. Su trabajo se orienta al fortalecimiento de capacidades 
locales para la conservaci√≥n del bosque tropical, integrando inventarios forestales, 
verificaci√≥n de planes de manejo y acompa√±amiento en procesos de certificaci√≥n y trazabilidad forestal.

BAREN es una entidad que presta servicios t√©cnicos ambientales y forestales, 
apoyando procesos de evaluaci√≥n, monitoreo y control en territorios bajo manejo comunitario
 y productivo. Su labor incluye inspecciones ambientales, acompa√±amiento t√©cnico en concesiones 
 forestales y asesor√≠a en cumplimiento normativo ante autoridades como CONAP y MARN.
</p>
                   <button class="bcard-btn" type="button" onclick="window.open('https://www.facebook.com/maderasbarencomercial?locale=ms_MY', '_blank');">Ver m√°s</button>
            </div>
          </article>
        </div>
        <!-- Slider Opini√≥n -->
        <div class="below-opinion">
          <div class="below-opinion-head">
            <div class="t">Opiniones sobre el proyecto de monitoreo</div>
            <div class="s">Espacio para compartir.</div>
          </div>

          <div class="bslider">
            <div class="bslides" id="bslides">
              <div class="bslide">
                <div class="bgrid">
                  <div class="bquote">
                    ‚ÄúEl Geoportal se ha convertido en una herramienta clave para la detecci√≥n temprana de incendios dentro de nuestra concesi√≥n. Antes depend√≠amos de reportes tard√≠os; ahora podemos visualizar en tiempo casi real los puntos de calor y organizar brigadas comunitarias con mayor rapidez. Esto fortalece la protecci√≥n del bosque y reduce p√©rdidas ambientales y econ√≥micas.‚Äù
                    <div class="bmeta">‚Äî √Ångel Rodas, AFISAP-</div>
                  </div>
                  <div class="bquote">
                    ‚ÄúLa integraci√≥n de datos satelitales provenientes de FIRMS dentro del Geoportal permite un an√°lisis espacial eficiente y operativo. La visualizaci√≥n geogr√°fica, combinada con filtros temporales y an√°lisis territorial, facilita la toma de decisiones estrat√©gicas en la Reserva de la Bi√≥sfera Maya. Es un ejemplo de c√≥mo la tecnolog√≠a geoespacial puede apoyar directamente la gobernanza ambiental.‚Äù
                    <div class="bmeta">‚Äî Inga. Claudia Saput, PACUNAM-</div>
                  </div>
                </div>
              </div>

              <div class="bslide">
                <div class="bgrid">
                  <div class="bquote">
                    ‚ÄúEl acceso abierto y visual al comportamiento de los puntos de calor nos da mayor autonom√≠a para monitorear nuestro territorio. No solo sirve para reaccionar ante incendios, sino tambi√©n para documentar amenazas externas y respaldar nuestros informes ante las autoridades ambientales. Es una herramienta que fortalece la gesti√≥n comunitaria del bosque.‚Äù
                    <div class="bmeta">‚Äî Comunitario, UAXACTUN-</div>
                  </div>
                  <div class="bquote">
                    ‚ÄúEl Geoportal representa un avance significativo en el monitoreo ambiental regional. Al centralizar informaci√≥n satelital en una plataforma accesible y din√°mica, mejora la coordinaci√≥n interinstitucional y permite priorizar √°reas cr√≠ticas. Su aporte es estrat√©gico para la conservaci√≥n de la Reserva de la Bi√≥sfera Maya y la reducci√≥n de la deforestaci√≥n asociada a incendios.‚Äù
                    <div class="bmeta">‚Äî Gerente, Carmelita-</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="bdots" id="bdots">
              <div class="bdot active" data-index="0"></div>
              <div class="bdot" data-index="1"></div>
            </div>
          </div>

          <div class="below-foot">
            <div>¬© <span id="yearNow"></span> ¬∑ Patrimonio Cultural y Natural Maya</div>
            <div class="below-links">
              <a href="#header">Principal</a>
              <a href="#map">Mapa</a>
              <a href="https://www.earthdata.nasa.gov/learn/find-data/near-real-time/firms" target="_blank">FIRMS</a>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- RIGHT -->
    <aside id="controls">
      <div id="controls-scroll">

        <!-- SUMMARY -->
        <div id="summary" class="panel">
          <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
            <div>
              <div class="muted2" style="font-weight:900; font-size:12px;">Cantidad de puntos de calor</div>
              <div class="big"><span id="total-points">0</span></div>
            </div>
          </div>

          <div class="kpi">
            <div class="row">
              <div>üå≤ Dentro de <b>Concesiones</b></div>
              <div style="font-weight:900;"><span id="count-concessions">0</span></div>
            </div>
            <div class="row">
              <div>üåø Dentro de <b>RBM</b></div>
              <div style="font-weight:900;"><span id="count-rbm">0</span></div>
            </div>
            <div class="row">
              <div>üá¨üáπ En <b>Guatemala</b></div>
              <div style="font-weight:900;"><span id="count-gt">0</span></div>
            </div>
          </div>

          <div class="note">
            Nota: Concesiones con puntos de calor se resaltan en <b>rojo</b>.
          </div>
        </div>

        <!-- LAST 10 -->
        <div id="last10-panel" class="panel">
          <div class="head">
            <h4 style="margin:1;">‚ö†Ô∏è √öltimos 10 puntos detectados</h4>
            <button id="btnRefresh" class="btnRefresh">Actualizar</button>
          </div>
          <div class="muted">Puntos de calor dentro de concesi√≥n resaltan en rojo.</div>
          <div id="listaLast10"></div>
        </div>

        <!-- CHART -->
        <div id="chart-container" class="panel">
          <canvas id="chart"></canvas>
        </div>

        <!-- FILTERS -->
        <div id="filters" class="panel">
          <div class="row">
            <label for="clusterCheckbox">Agrupar puntos de calor (Cluster)</label>
            <input type="checkbox" id="clusterCheckbox" checked />
          </div>

          <h3 style="margin:0 0 8px 0;">Filtrar R√°pido</h3>

          <button class="btn" id="todayButton">√öltimas 24 Horas</button>
          <button class="btn" id="last48HoursButton">√öltimas 48 Horas</button>
          <button class="btn" id="last72HoursButton">√öltimas 72 Horas</button>
          <button class="btn" id="last8DaysButton">√öltimos 8 D√≠as</button>

          <button class="btn" id="resetRangeButton" style="display:none;">üîô Volver al rango</button>
        </div>

        <!-- CONCESION PANEL -->
        <div id="concesion-panel" class="panel">
          <h3>üü° Gr√°fico de puntos de calor por Concesi√≥n</h3>

          <div class="chartbox">
            <canvas id="chartConcesiones"></canvas>
          </div>

          <button id="btnXLSConcesiones" class="btnXLS">üì• Descargar Excel (Concesiones)</button>
          <button id="btnXLSRBM" class="btnXLS">üì• Descargar Excel (RBM)</button>
          <button id="btnXLSGT" class="btnXLS">üì• Descargar Excel (Guatemala)</button>

          <div id="totalVisibleBox">Total dentro de Concesiones: <span id="totalVisible">0</span></div>
          <div id="listaConcesiones"></div>
        </div>

      </div>
    </aside>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet.geometryutil"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.js"></script>

  <script>
    /* =========================
       Overlay carga
    ========================== */
    var loadingOverlay = document.getElementById("loadingOverlay");
    var loadingBar = document.getElementById("loadingBar");
    var loadingText = document.getElementById("loadingText");

    function showLoading(msg){
      loadingOverlay.style.display = "flex";
      loadingBar.style.width = "0%";
      loadingText.textContent = msg || "Cargando‚Ä¶";
    }
    function setLoadingProgress(pct, msg){
      var v = Math.max(0, Math.min(100, pct || 0));
      loadingBar.style.width = v + "%";
      if (msg) loadingText.textContent = msg;
    }
    function hideLoading(){ loadingOverlay.style.display = "none"; }

    /* =========================
       Tooltip √°rea (Draw)
    ========================== */
    function createAreaTooltip(layer) {
      if (layer.areaTooltip) return;

      layer.areaTooltip = L.tooltip({
        permanent: true,
        direction: 'center',
        className: 'area-tooltip'
      });

      layer.on('remove', function() { layer.areaTooltip.remove(); });
      layer.on('add', function() {
        updateAreaTooltip(layer);
        layer.areaTooltip.addTo(map);
      });

      if (map.hasLayer(layer)) {
        updateAreaTooltip(layer);
        layer.areaTooltip.addTo(map);
      }
    }

    function updateAreaTooltip(layer) {
      var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
      var readableArea = L.GeometryUtil.readableArea(area, true);
      var latlng = layer.getCenter();
      layer.areaTooltip.setContent(readableArea).setLatLng(latlng);
    }

    /* =========================
       MAPA
    ========================== */
    var map = L.map('map', {
      fullscreenControl: true,
      fullscreenControlOptions: { position: 'topright' },
      maxBounds: [[6.358285,-97.674955],[23.563182,-73.021632]],
      minZoom: 6
    }).setView([16.939224, -90.231038], 8.50);

    var ggl = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    });

    var osm = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
      attribution: '&copy; Google Hybrid'
    }).addTo(map);

    var gglmps = L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {
      attribution: '&copy; Google Maps'
    });

    var capas = {
      '<big> üåè Google Hybrid</big>': osm,
      '<big> üåê Open street map</big>': ggl,
      '<big> üó∫Ô∏è Google Maps</big>': gglmps
    };

    function getColor(d) {
      return d > 350 ? '#FF0000' : d > 300 ? '#FF4500' : '#FFFF00';
    }
    function formatAcqTime(acqTime) {
      var date = new Date(acqTime);
      return date.toLocaleString();
    }
    function formatCoordinate(coordinate) { return Number(coordinate).toFixed(4); }

    /* =========================
       ‚úÖ TOP 10 m√°s recientes = fuego activo
    ========================== */
    var last10Keys = new Set();

    function getFeatureKey(f){
      var p = f.properties || {};
      if (p.objectid != null) return "oid_" + p.objectid;
      if (p.OBJECTID != null) return "oid_" + p.OBJECTID;
      if (p.ObjectId != null) return "oid_" + p.ObjectId;

      var lon = (p.longitude != null) ? p.longitude : (f.geometry?.coordinates?.[0]);
      var lat = (p.latitude  != null) ? p.latitude  : (f.geometry?.coordinates?.[1]);
      return "k_" + String(p.acq_time || "") + "_" + String(lat || "") + "_" + String(lon || "");
    }

    function computeLast10Set(data){
      last10Keys = new Set();
      if (!data || !data.features || !data.features.length) return;

      var arr = data.features
        .map(f => {
          var t = 0;
          try { t = new Date((f.properties || {}).acq_time).getTime(); } catch(e){}
          return { f: f, t: t };
        })
        .filter(x => x.t > 0)
        .sort((a,b) => b.t - a.t)
        .slice(0, 10);

      arr.forEach(x => last10Keys.add(getFeatureKey(x.f)));
    }

    // üî• Puedes cambiar a llama si quieres:
    // var FIRE_GIF_URL = "https://images.emojiterra.com/google/noto-emoji/animated-emoji/1f525.gif";
    var FIRE_GIF_URL = "https://images.emojiterra.com/google/noto-emoji/animated-emoji/26a0.gif";

    function makeFireDivIcon(size){
      size = size || 56;
      return L.divIcon({
        className: "",
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        html: `
          <div style="
            width:${size}px; height:${size}px;
            border-radius: 50%;
            display:flex; align-items:center; justify-content:center;
            background: rgba(0,0,0,0.25);
            box-shadow:
              0 0 0 3px rgba(255, 80, 80, 0.55),
              0 0 28px rgba(255, 80, 80, 0.85),
              0 0 55px rgba(255, 180, 0, 0.70);
            border: 1px solid rgba(255,255,255,0.25);
          ">
            <img src="${FIRE_GIF_URL}" style="
              width:${Math.round(size*0.78)}px;
              height:${Math.round(size*0.78)}px;
              object-fit:contain;
              filter: drop-shadow(0 6px 10px rgba(0,0,0,0.45));
            " />
          </div>
        `
      });
    }

    /* =========================
       ‚úÖ ArcGIS query (PJSON -> GeoJSON)
    ========================== */
    var FEATURE_URL = "https://sig.inab.gob.gt/server/rest/services/Hosted/Satellite_VIIRS_MODIS_Vista/FeatureServer/0/query";
    var LAYER_INFO_URL = "https://sig.inab.gob.gt/server/rest/services/Hosted/Satellite_VIIRS_MODIS_Vista/FeatureServer/0?f=pjson";

    var OID_FIELD = "OBJECTID";
    var MAX_RECORDS = 1000;
    var _metaReady = false;

    async function initLayerInfo(forceNoCache){
      if (_metaReady && !forceNoCache) return;
      try{
        const r = await fetch(LAYER_INFO_URL + (forceNoCache ? ("&cb=" + Date.now()) : ""));
        const info = await r.json();
        if (info && info.objectIdField) OID_FIELD = info.objectIdField;
        if (info && info.maxRecordCount) MAX_RECORDS = info.maxRecordCount;
        _metaReady = true;
      }catch(e){
        console.warn("No pude leer metadata layer. Uso defaults.", e);
        _metaReady = true;
      }
    }

    async function fetchText(url){
      const r = await fetch(url);
      return await r.text();
    }

    function arcgisPjsonToGeoJSON(pjson){
      const fc = { type:"FeatureCollection", features:[] };
      const feats = (pjson && pjson.features) ? pjson.features : [];
      for (let i=0;i<feats.length;i++){
        const f = feats[i];
        const attrs = f.attributes || {};
        const g = f.geometry || {};
        if (g.x === undefined || g.y === undefined) continue;
        fc.features.push({
          type:"Feature",
          geometry: { type:"Point", coordinates:[Number(g.x), Number(g.y)] },
          properties: attrs
        });
      }
      return fc;
    }

    async function fetchArcGISAsGeoJSON(url){
      const txt = await fetchText(url);

      if (txt && txt.trim().startsWith("<")){
        throw new Error("El servidor devolvi√≥ HTML (servicio ca√≠do o error interno).");
      }

      let json;
      try{ json = JSON.parse(txt); }
      catch(e){ throw new Error("Respuesta inv√°lida del servidor (no JSON)."); }

      if (json && json.error){
        const msg = (json.error.message || "Error ArcGIS")
          + (json.error.details ? (" | " + json.error.details.join(" | ")) : "");
        throw new Error(msg);
      }

      return arcgisPjsonToGeoJSON(json);
    }

    function parseTimeMsFromFeature(f){
      const p = f.properties || {};
      let v = p.acq_time;

      if (typeof v === "number") return v;

      if (typeof v === "string"){
        const t = new Date(v).getTime();
        if (!isNaN(t)) return t;

        const asNum = Number(v);
        if (!isNaN(asNum) && asNum > 1000000000) return asNum;
      }

      return NaN;
    }

    /* ==========================================================
       ‚úÖ IMPORTANTE:
       ‚úÖ NUNCA usa where acq_time <= ...
       ‚úÖ SIEMPRE: orderByFields=OID DESC y filtra localmente
    ========================================================== */
    async function fetchRangeFromServer(hours, forceNoCache){
      await initLayerInfo(forceNoCache);

      const now = new Date();
      const past = new Date(now.getTime() - hours*60*60*1000);

      const outFields = [
        OID_FIELD, "latitude","longitude","bright_ti4",
        "acq_time","satellite","depto","municipio","concat_2","gtm_x","gtm_y"
      ].join(",");

      const limit = Math.min(2000, MAX_RECORDS || 1000);
      let offset = 0;
      let page = 0;
      let all = { type:"FeatureCollection", features:[] };

      while(true){
        page++;
        setLoadingProgress(Math.min(90, page*20), `Descargando recientes‚Ä¶ p√°gina ${page}`);

        const cb = forceNoCache ? ("&cb=" + Date.now()) : "";
        const url =
          `${FEATURE_URL}?where=1%3D1`
          + `&outFields=${encodeURIComponent(outFields)}`
          + `&outSR=4326&f=pjson`
          + `&orderByFields=${encodeURIComponent(OID_FIELD + " DESC")}`
          + `&resultOffset=${offset}&resultRecordCount=${limit}`
          + cb;

        const gj = await fetchArcGISAsGeoJSON(url);

        if (gj.features && gj.features.length){
          for (const ft of gj.features){
            const t = parseTimeMsFromFeature(ft);
            if (!isNaN(t) && t >= past.getTime() && t <= now.getTime()){
              all.features.push(ft);
            }
          }

          const last = gj.features[gj.features.length - 1];
          const lastT = parseTimeMsFromFeature(last);
          if (!isNaN(lastT) && lastT < past.getTime()){
            break;
          }
        }

        if (!gj.features || gj.features.length < limit) break;

        offset += limit;
        if (page > 15) break; // seguridad
      }

      return all;
    }

    /* =========================
       Variables globales
    ========================== */
    var rangeData = null;
    var mapData   = null;
    var currentRangeHours = 24;

    var markersToday = null;
    var markersOthers = null;

    /* =========================
       CONTEO ESPACIAL (Concesiones / RBM / Guatemala)
    ========================== */
    var concesionesFeatures = [];
    var concesionesIndex = [];

    var rbmFeatures = [];
    var rbmIndex = [];

    var gtFeature = null;
    var GT_GEOJSON_URL = "https://raw.githubusercontent.com/johan/world.geo.json/master/countries/GTM.geo.json";

    function buildBBoxIndex(features) {
      return (features || []).map(f => ({ feature: f, bbox: turf.bbox(f) }));
    }
    function bboxContainsPoint(bbox, lon, lat) {
      return lon >= bbox[0] && lon <= bbox[2] && lat >= bbox[1] && lat <= bbox[3];
    }
    function pointInFeature(lon, lat, feature) {
      if (!feature) return false;
      try { return turf.booleanPointInPolygon(turf.point([lon, lat]), feature); }
      catch (e) { return false; }
    }

    function getConcessionName(feature){
      var p = feature && feature.properties ? feature.properties : {};
      return p.ZON_NOM || p.NOMBRE || p.Nombre || p.NAME || p.name || p.CONCESION || p.Concesion || p.concesion || "Concesi√≥n";
    }

    function getConcessionNameFromPoint(lon, lat) {
      if (!concesionesIndex.length) return null;
      var pt = turf.point([lon, lat]);

      for (var i = 0; i < concesionesIndex.length; i++) {
        var c = concesionesIndex[i];
        if (!bboxContainsPoint(c.bbox, lon, lat)) continue;
        try {
          if (turf.booleanPointInPolygon(pt, c.feature)) return getConcessionName(c.feature);
        } catch(e){}
      }
      return null;
    }
    function pointInAnyConcession(lon, lat) { return !!getConcessionNameFromPoint(lon, lat); }

    function pointInAnyRBM(lon, lat) {
      if (!rbmIndex.length) return false;
      var pt = turf.point([lon, lat]);

      for (var i = 0; i < rbmIndex.length; i++) {
        var r = rbmIndex[i];
        if (!bboxContainsPoint(r.bbox, lon, lat)) continue;
        try {
          if (turf.booleanPointInPolygon(pt, r.feature)) return true;
        } catch(e){}
      }
      return false;
    }

    var spatialCache = new Map();

    function updateSpatialCounters(data) {
      var countCon = 0, countRBM = 0, countGT = 0;

      if (!data || !data.features || !data.features.length) {
        document.getElementById('count-concessions').textContent = "0";
        document.getElementById('count-rbm').textContent = "0";
        document.getElementById('count-gt').textContent = "0";
        return;
      }

      for (var i = 0; i < data.features.length; i++) {
        var f = data.features[i];
        if (!f.geometry || !f.geometry.coordinates) continue;

        var lon = f.geometry.coordinates[0];
        var lat = f.geometry.coordinates[1];

        var key = getFeatureKey(f);
        var cached = spatialCache.get(key);

        if (!cached){
          var inGT = gtFeature ? pointInFeature(lon, lat, gtFeature) : true;
          var inRBM = rbmIndex.length ? pointInAnyRBM(lon, lat) : false;
          var cName = concesionesIndex.length ? getConcessionNameFromPoint(lon, lat) : null;
          var inCon = !!cName;

          cached = { gt: inGT, rbm: inRBM, con: inCon, concesionName: cName };
          spatialCache.set(key, cached);
        }

        if (cached.gt) countGT++;
        if (cached.rbm) countRBM++;
        if (cached.con) countCon++;
      }

      document.getElementById('count-concessions').textContent = countCon.toLocaleString();
      document.getElementById('count-rbm').textContent = countRBM.toLocaleString();
      document.getElementById('count-gt').textContent = countGT.toLocaleString();
    }

    function updateSummary(total) {
      document.getElementById('total-points').textContent = total.toLocaleString();
    }

    /* =========================
       Concesiones resaltadas
    ========================== */
    var concesionesLayer = null;
    var concessionHeatCounts = {};

    function concesionStyle(feature){
      var name = getConcessionName(feature);
      var has = (concessionHeatCounts[name] || 0) > 0;
      if (has) return { color:'#ff2d2d', weight:3, fillOpacity:0.12 };
      return { color:'cyan', weight:1, fillOpacity:0.00 };
    }
    function updateConcessionStylesFromCounts(countsMap){
      concessionHeatCounts = countsMap || {};
      if (concesionesLayer) concesionesLayer.setStyle(concesionStyle);
    }

    /* =========================
       Panel concesi√≥n
    ========================== */
    var chartConcesiones = null;

    function actualizarGraficoConcesiones(data){
      if (!data || !data.features) return;

      var conteo = {};
      var totalDentroConcesiones = 0;
      var listItems = [];

      data.features.forEach(f => {
        if (!f.geometry || !f.geometry.coordinates) return;

        var lon = f.geometry.coordinates[0];
        var lat = f.geometry.coordinates[1];

        var key = getFeatureKey(f);
        var cached = spatialCache.get(key);
        var nombre = cached ? cached.concesionName : getConcessionNameFromPoint(lon, lat);
        if (!nombre) return;

        conteo[nombre] = (conteo[nombre] || 0) + 1;
        totalDentroConcesiones++;

        listItems.push({
          concesion: nombre,
          fecha: formatAcqTime((f.properties || {}).acq_time),
          fechaEpoch: new Date((f.properties || {}).acq_time).getTime(),
          lat: lat,
          lon: lon
        });
      });

      updateConcessionStylesFromCounts(conteo);

      var etiquetas = Object.keys(conteo).sort((a,b)=> (conteo[b]||0)-(conteo[a]||0));
      var valores = etiquetas.map(k => conteo[k]);

      if (chartConcesiones) chartConcesiones.destroy();
      var ctx = document.getElementById("chartConcesiones").getContext("2d");

      chartConcesiones = new Chart(ctx, {
        type: "bar",
        data: {
          labels: etiquetas,
          datasets: [{
            label: "Puntos",
            data: valores,
            backgroundColor: "rgba(255,99,132,0.55)",
            borderColor: "rgba(255,99,132,1)",
            borderWidth: 1,
            borderRadius: 10
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display:false } },
          scales: {
            x: { beginAtZero:true, ticks:{ color:"rgba(255,255,255,0.85)" }, grid:{ color:"rgba(255,255,255,0.10)" } },
            y: { beginAtZero:true, ticks:{ color:"rgba(255,255,255,0.85)" }, grid:{ color:"rgba(255,255,255,0.06)" } }
          }
        }
      });

      document.getElementById("totalVisible").innerText = totalDentroConcesiones.toLocaleString();

      var listaDiv = document.getElementById("listaConcesiones");
      listaDiv.innerHTML = "";

      listItems.sort((a,b)=> b.fechaEpoch - a.fechaEpoch);

      var maxItems = Math.min(50, listItems.length);
      for (var i=0; i<maxItems; i++){
        (function(item){
          var card = document.createElement("div");
          card.className = "cardPoint";
          card.innerHTML = `
            ‚ö†Ô∏è <b>Concesi√≥n:</b> ${item.concesion}<br>
            <b>Fecha y hora:</b> ${item.fecha}<br>
            <b>Lat:</b> ${item.lat.toFixed(5)} &nbsp; <b>Lon:</b> ${item.lon.toFixed(5)}
          `;
          card.addEventListener("click", function(){
            map.flyTo([item.lat, item.lon], 14);
          });
          listaDiv.appendChild(card);
        })(listItems[i]);
      }

      if (listItems.length === 0){
        listaDiv.innerHTML = `<div class="cardPoint">No hay puntos dentro de concesiones en el rango actual.</div>`;
      }
    }

    /* =========================
       ‚úÖ Render lista √∫ltimos 10
    ========================== */
    function renderLast10List(data){
      var lista = document.getElementById("listaLast10");
      lista.innerHTML = "";

      if (!data || !data.features || !data.features.length){
        lista.innerHTML = `<div class="last10Card">No hay datos en el rango actual.</div>`;
        return;
      }

      // tomar solo los 10 m√°s recientes (por acq_time)
      var items = data.features
        .map(f => {
          var p = f.properties || {};
          var lat = (p.latitude != null) ? Number(p.latitude) : Number(f.geometry?.coordinates?.[1]);
          var lon = (p.longitude != null) ? Number(p.longitude) : Number(f.geometry?.coordinates?.[0]);
          var t = parseTimeMsFromFeature(f);

          var key = getFeatureKey(f);
          var cached = spatialCache.get(key);
          var concesionName = cached ? cached.concesionName : (concesionesIndex.length ? getConcessionNameFromPoint(lon, lat) : null);

          return {
            f: f,
            key: key,
            t: t,
            lat: lat,
            lon: lon,
            depto: p.depto || "N/D",
            municipio: p.municipio || "N/D",
            acq: p.acq_time,
            concesionName: concesionName,
            inCon: !!concesionName
          };
        })
        .filter(x => !isNaN(x.t))
        .sort((a,b)=> b.t - a.t)
        .slice(0, 10);

      if (!items.length){
        lista.innerHTML = `<div class="last10Card">No se pudieron leer fechas (acq_time) del servicio.</div>`;
        return;
      }

      items.forEach((it, idx) => {
        var card = document.createElement("div");
        card.className = "last10Card" + (it.inCon ? " blink-red" : "");

        var concesionTxt = it.inCon ? it.concesionName : "Fuera";

        card.innerHTML = `
          ‚ö†Ô∏è <b>${idx+1}. ${formatAcqTime(it.acq)}</b><br>
          <b>Depto:</b> ${it.depto} &nbsp; <b>Municipio:</b> ${it.municipio}<br>
          <b>Lat:</b> ${it.lat.toFixed(5)} &nbsp; <b>Lon:</b> ${it.lon.toFixed(5)}<br>
          <b>Concesi√≥n:</b> ${concesionTxt}
        `;

        card.addEventListener("click", function(){
          map.flyTo([it.lat, it.lon], 14);
        });

        lista.appendChild(card);
      });
    }

    /* =========================
       Excel
    ========================== */
    function fmtDateForExcel(v){
      if (!v) return "";
      try { return new Date(v).toLocaleString(); } catch(e){ return String(v); }
    }

    function featureToRow(f){
      var p = f.properties || {};
      var lat = (p.latitude != null) ? p.latitude : (f.geometry?.coordinates?.[1]);
      var lon = (p.longitude != null) ? p.longitude : (f.geometry?.coordinates?.[0]);

      return {
        latitude:  (lat !== undefined ? Number(lat) : ""),
        longitude: (lon !== undefined ? Number(lon) : ""),
        acq_time:  fmtDateForExcel(p.acq_time),
        satellite: (p.satellite ?? ""),
        Depto:     (p.depto ?? ""),
        MUNICIPIO: (p.municipio ?? ""),
        gtm_x:     (p.gtm_x ?? ""),
        gtm_y:     (p.gtm_y ?? "")
      };
    }

    function filterFeaturesByScope(data, scope){
      if (!data || !data.features) return [];
      var feats = data.features;

      if (scope === "concesiones"){
        return feats.filter(f => {
          var p = f.properties || {};
          var lon = (p.longitude != null) ? p.longitude : (f.geometry?.coordinates?.[0]);
          var lat = (p.latitude  != null) ? p.latitude  : (f.geometry?.coordinates?.[1]);
          if (lon === undefined || lat === undefined) return false;
          return pointInAnyConcession(Number(lon), Number(lat));
        });
      }

      if (scope === "rbm"){
        return feats.filter(f => {
          var p = f.properties || {};
          var lon = (p.longitude != null) ? p.longitude : (f.geometry?.coordinates?.[0]);
          var lat = (p.latitude  != null) ? p.latitude  : (f.geometry?.coordinates?.[1]);
          if (lon === undefined || lat === undefined) return false;
          return pointInAnyRBM(Number(lon), Number(lat));
        });
      }

      return feats.filter(f => {
        var p = f.properties || {};
        var lon = (p.longitude != null) ? p.longitude : (f.geometry?.coordinates?.[0]);
        var lat = (p.latitude  != null) ? p.latitude  : (f.geometry?.coordinates?.[1]);
        if (lon === undefined || lat === undefined) return false;
        if (!gtFeature) return true;
        return pointInFeature(Number(lon), Number(lat), gtFeature);
      });
    }

    function downloadXLSX(scope){
      var data = (mapData || rangeData);
      if (!data || !data.features || !data.features.length){
        alert("No hay datos para descargar en el rango actual.");
        return;
      }

      if (scope === "concesiones" && !concesionesIndex.length){
        alert("A√∫n no termina de cargar Concesiones. Espera 2-3 segundos y prueba de nuevo.");
        return;
      }
      if (scope === "rbm" && !rbmIndex.length){
        alert("A√∫n no termina de cargar RBM. Espera 2-3 segundos y prueba de nuevo.");
        return;
      }

      var feats = filterFeaturesByScope(data, scope);
      if (!feats.length){
        alert("No hay puntos para ese √°mbito en el rango actual.");
        return;
      }

      var rows = feats.map(featureToRow);

      var ws = XLSX.utils.json_to_sheet(rows, {
        header: ["latitude","longitude","acq_time","satellite","Depto","MUNICIPIO","gtm_x","gtm_y"]
      });

      ws["!cols"] = [
        { wch: 10 }, { wch: 11 }, { wch: 22 }, { wch: 10 },
        { wch: 18 }, { wch: 18 }, { wch: 12 }, { wch: 12 }
      ];

      var wb = XLSX.utils.book_new();
      var sheetName = (scope === "concesiones") ? "Concesiones" : (scope === "rbm") ? "RBM" : "Guatemala";
      XLSX.utils.book_append_sheet(wb, ws, sheetName);

      var hours = currentRangeHours || 24;
      var now = new Date();
      var y = now.getFullYear();
      var m = String(now.getMonth()+1).padStart(2,"0");
      var d = String(now.getDate()).padStart(2,"0");
      var hh = String(now.getHours()).padStart(2,"0");
      var mm = String(now.getMinutes()).padStart(2,"0");

      var filename = `puntos_calor_${sheetName}_${hours}h_${y}${m}${d}_${hh}${mm}.xlsx`;
      XLSX.writeFile(wb, filename);
    }

    document.getElementById("btnXLSConcesiones").addEventListener("click", function(){ downloadXLSX("concesiones"); });
    document.getElementById("btnXLSRBM").addEventListener("click", function(){ downloadXLSX("rbm"); });
    document.getElementById("btnXLSGT").addEventListener("click", function(){ downloadXLSX("gt"); });

    /* =========================
       MAPA: dibujar puntos (cluster fixed)
    ========================== */
    function updateMap(data, useCluster) {
      mapData = data;

      computeLast10Set(data);

      if (markersToday) map.removeLayer(markersToday);
      if (markersOthers) map.removeLayer(markersOthers);

      // grupos
      if (useCluster) {
        markersToday = L.markerClusterGroup();
        markersOthers = L.markerClusterGroup();
      } else {
        markersToday = L.layerGroup();
        markersOthers = L.layerGroup();
      }

      var today = new Date().toISOString().split('T')[0];

      var todayFeatures = (data.features || []).filter(f => new Date(f.properties.acq_time).toISOString().split('T')[0] === today);
      var otherFeatures = (data.features || []).filter(f => new Date(f.properties.acq_time).toISOString().split('T')[0] !== today);

      function pointLayer(feature, latlng){
        var key = getFeatureKey(feature);

        if (last10Keys.has(key)){
          return L.marker(latlng, { icon: makeFireDivIcon(62), riseOnHover:true });
        }

        var p = feature.properties || {};
        return L.circleMarker(latlng, {
          radius: 7,
          fillColor: getColor(p.bright_ti4),
          color: getColor(p.bright_ti4),
          weight: 1,
          opacity: 1,
          fillOpacity: 0.80
        });
      }

      function bindPopup(feature, layer){
        var p = feature.properties || {};
        var popupContent = `
          <strong>Hora de detecci√≥n:</strong> ${formatAcqTime(p.acq_time)}<br>
          <strong>Latitud:</strong> ${formatCoordinate(p.latitude ?? feature.geometry.coordinates[1])}<br>
          <strong>Longitud:</strong> ${formatCoordinate(p.longitude ?? feature.geometry.coordinates[0])}<br>
          <strong>Categor√≠a:</strong> ${p.concat_2 || 'N/D'}<br>
          <strong>Depto:</strong> ${p.depto || 'N/D'}<br>
          <strong>Municipio:</strong> ${p.municipio || 'N/D'}<br>
          <strong>Sat√©lite:</strong> ${p.satellite || 'N/D'}
        `;
        layer.bindPopup(popupContent);
      }

      // ‚úÖ Para que Cluster funcione SIEMPRE:
      // creamos geojson layer, luego metemos cada capa al cluster/group
      function addFeaturesToGroup(features, group){
        var gj = L.geoJSON({type:"FeatureCollection", features:features}, {
          pointToLayer: pointLayer,
          onEachFeature: bindPopup
        });
        gj.eachLayer(function(layer){
          group.addLayer(layer);
        });
      }

      addFeaturesToGroup(todayFeatures, markersToday);
      addFeaturesToGroup(otherFeatures, markersOthers);

      map.addLayer(markersToday);
      map.addLayer(markersOthers);

      updateSummary((data.features || []).length);
      updateSpatialCounters(data);
      actualizarGraficoConcesiones(data);
      renderLast10List(data);
    }

    /* =========================
       Chart principal (por d√≠a)
    ========================== */
    function filterDataByDate(data, date) {
      return {
        type: "FeatureCollection",
        features: (data.features || []).filter(feature => {
          var acqDate = new Date(feature.properties.acq_time).toISOString().split('T')[0];
          return acqDate === date;
        })
      };
    }

    function updateChart(data) {
      var dateCounts = (data.features || []).reduce((acc, feature) => {
        var date = new Date(feature.properties.acq_time).toISOString().split('T')[0];
        acc[date] = (acc[date] || 0) + 1;
        return acc;
      }, {});

      var sortedDates = Object.keys(dateCounts).sort((a,b) => new Date(a) - new Date(b));
      var sortedCounts = sortedDates.map(d => dateCounts[d]);

      chart.data.labels = sortedDates;
      chart.data.datasets[0].data = sortedCounts;
      chart.update();
    }

    var selectedBarIndex = null;

    var chart = new Chart(document.getElementById('chart'), {
      type: 'bar',
      data: { labels: [], datasets: [{
        label: 'Puntos',
        data: [],
        borderWidth: 0,
        borderRadius: 10,
        borderSkipped: false,
        barThickness: 18,
        maxBarThickness: 22,
        backgroundColor: function(ctx){
          var i = ctx.dataIndex;
          if (selectedBarIndex !== null && i === selectedBarIndex) return 'rgba(56, 178, 172, 0.95)';
          return 'rgba(56, 178, 172, 0.55)';
        },
        hoverBackgroundColor: 'rgba(56, 178, 172, 0.9)'
      }]},
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: true, text:"Puntos por d√≠a (rango actual)", color: 'white' }
        },
        scales: {
          x: { grid: { display:false }, ticks:{ color:'rgba(255,255,255,0.85)', maxTicksLimit:6 } },
          y: { beginAtZero:true, ticks:{ color:'rgba(255,255,255,0.85)' } }
        },
        onClick: function(event, elements) {
          if (elements.length > 0) {
            selectedBarIndex = elements[0].index;
            var date = this.data.labels[selectedBarIndex];
            var filteredData = filterDataByDate(rangeData, date);
            document.getElementById('resetRangeButton').style.display = 'block';
            updateMap(filteredData, document.getElementById('clusterCheckbox').checked);
            chart.update();
          }
        }
      }
    });

    /* =========================
       RANGOS
    ========================== */
    async function applyRange(hours, forceNoCache) {
      currentRangeHours = hours;
      selectedBarIndex = null;
      document.getElementById('resetRangeButton').style.display = 'none';

      showLoading(`Cargando puntos (${hours}h)‚Ä¶`);
      document.getElementById('total-points').textContent = "‚Ä¶";

      try{
        spatialCache = new Map();

        setLoadingProgress(10, "Consultando servicio‚Ä¶");
        rangeData = await fetchRangeFromServer(hours, !!forceNoCache);

        setLoadingProgress(85, "Calculando capas‚Ä¶");
        updateChart(rangeData);
        updateMap(rangeData, document.getElementById('clusterCheckbox').checked);
        chart.update();

        setLoadingProgress(100, "Listo");
        setTimeout(hideLoading, 200);
      } catch(e){
        console.error("Fallo cargando datos:", e);
        hideLoading();
        alert("Error cargando datos: " + (e.message || e));
      }
    }

    /* =========================
       RBM + Concesiones (overlays)
    ========================== */
    var rbmLayer = L.geoJSON(null, { style: () => ({ color:'blue', weight:1, fillOpacity:0 }) });
    concesionesLayer = L.geoJSON(null, { style: concesionStyle });

    fetch('https://raw.githubusercontent.com/nestorcaalsuc/RBM/main/RBM.geojson')
      .then(r => r.json()).then(d => {
        rbmLayer.addData(d);
        rbmFeatures = (d && d.features) ? d.features : [];
        rbmIndex = buildBBoxIndex(rbmFeatures);
      }).catch(e => console.warn("RBM no carg√≥:", e));

    fetch('https://raw.githubusercontent.com/nestorcaalsuc/RBM/main/Concesiones.geojson')
      .then(r => r.json()).then(d => {
        concesionesLayer.addData(d);
        concesionesFeatures = (d && d.features) ? d.features : [];
        concesionesIndex = buildBBoxIndex(concesionesFeatures);
        updateConcessionStylesFromCounts({});
      }).catch(e => console.warn("Concesiones no carg√≥:", e));

    fetch(GT_GEOJSON_URL)
      .then(r => r.json())
      .then(d => { gtFeature = (d.type === "Feature") ? d : (d.features && d.features[0]); })
      .catch(e => console.warn("GT no carg√≥:", e));

    concesionesLayer.addTo(map);
    rbmLayer.addTo(map);

    /* =========================
       ‚≠ê CONTROL DE CAPAS CON ENCABEZADOS
    ========================== */
    function HeadingLayer(){ return L.layerGroup(); }

    const OVERLAYS_HEADERS = {
      '<span class="lc-heading">üß≠ <big>L√≠mites y Gesti√≥n</big></span>': HeadingLayer(),
      '<big> üå≤ Concesiones Forestales</big>': concesionesLayer,
      '<big> üåø L√≠mite RBM</big>': rbmLayer,
    };

    const controlCapas = L.control.layers(
      capas,
      OVERLAYS_HEADERS,
      { collapsed:true, position:'topleft' }
    ).addTo(map);

    function beautifyHeadings(){
      const cont = controlCapas._container?.querySelector('.leaflet-control-layers-overlays');
      if (!cont) return;
      cont.querySelectorAll('label').forEach(label => {
        if (label.innerHTML.includes('lc-heading')){
          label.classList.add('is-heading');
        }
      });
    }
    setTimeout(beautifyHeadings, 120);

    /* ‚úÖ Escala */
    L.control.scale({ imperial:false, position:'bottomleft' }).addTo(map);

    /* =========================
       Draw control
    ========================== */
    var drawnItems = L.featureGroup().addTo(map);

    map.addControl(new L.Control.Draw({
      edit: { featureGroup: drawnItems, poly: { allowIntersection: false } },
      draw: {
        marker: true,
        circle: true,
        circlemarker: false,
        rectangle: true,
        polyline: true,
        polygon: { allowIntersection: false, showArea: true }
      }
    }));

    map.on(L.Draw.Event.CREATED, function(event) {
      var layer = event.layer;
      if (layer instanceof L.Polygon) createAreaTooltip(layer);
      drawnItems.addLayer(layer);
    });

    map.on(L.Draw.Event.EDITED, function(event) {
      event.layers.getLayers().forEach(function(layer) {
        if (layer instanceof L.Polygon) updateAreaTooltip(layer);
      });
    });

    /* =========================
       Eventos UI
    ========================== */
    document.getElementById('todayButton').addEventListener('click', () => applyRange(24, false));
    document.getElementById('last48HoursButton').addEventListener('click', () => applyRange(48, false));
    document.getElementById('last72HoursButton').addEventListener('click', () => applyRange(72, false));
    document.getElementById('last8DaysButton').addEventListener('click', () => applyRange(8 * 24, false));

    document.getElementById('resetRangeButton').addEventListener('click', function(){
      applyRange(currentRangeHours, false);
    });

    document.getElementById('clusterCheckbox').addEventListener('change', function(){
      updateMap(mapData || rangeData, this.checked);
    });

    // ‚úÖ Bot√≥n refrescar (sin cach√©)
    document.getElementById('btnRefresh').addEventListener('click', function(){
      applyRange(currentRangeHours, true);
    });

    /* =========================
       Slider Opini√≥n (sin librer√≠as)
    ========================== */
    document.getElementById("yearNow").textContent = new Date().getFullYear();
    (function(){
      const slides = document.getElementById("bslides");
      const dots = Array.from(document.querySelectorAll("#bdots .bdot"));
      let idx = 0;

      function go(i){
        idx = (i + dots.length) % dots.length;
        slides.style.transform = `translateX(${-idx*50}%)`;
        dots.forEach(d=>d.classList.remove("active"));
        dots[idx].classList.add("active");
      }

      dots.forEach(d => d.addEventListener("click", () => go(Number(d.dataset.index))));
      go(0);
    })();

    /* =========================
       INIT
    ========================== */
    (async function init(){
      await applyRange(24, false);
    })();
  </script>
</body>
</html>
